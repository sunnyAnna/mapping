!function(a,b){"function"==typeof define&&define.amd?define([],b):a.JSO=b()}(this,function(){var a,b,c;return function(d){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(n=n.slice(0,n.length-1),a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(a,b){return function(){return n.apply(d,v.call(arguments,0).concat([a,b]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(a){if(e(r,a)){var b=r[a];delete r[a],t[a]=!0,m.apply(d,b)}if(!e(q,a)&&!e(t,a))throw new Error("No "+a);return q[a]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(a,b,c,f){var h,k,l,m,n,s,u=[],v=typeof c;if(f=f||a,"undefined"===v||"function"===v){for(b=!b.length&&c.length?["require","exports","module"]:b,n=0;n<b.length;n+=1)if(m=o(b[n],f),k=m.f,"require"===k)u[n]=p.require(a);else if("exports"===k)u[n]=p.exports(a),s=!0;else if("module"===k)h=u[n]=p.module(a);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(a+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=c?c.apply(q[a],u):void 0,a&&(h&&h.exports!==d&&h.exports!==q[a]?q[a]=h.exports:l===d&&s||(q[a]=l))}else a&&(q[a]=c)},a=b=n=function(a,b,c,e,f){if("string"==typeof a)return p[a]?p[a](b):j(o(a,b).f);if(!a.splice){if(s=a,s.deps&&n(s.deps,s.callback),!b)return;b.splice?(a=b,b=c,c=null):a=d}return b=b||function(){},"function"==typeof c&&(c=e,e=f),e?m(d,a,b,c):setTimeout(function(){m(d,a,b,c)},4),n},n.config=function(a){return n(a)},a._defined=q,c=function(a,b,c){b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},c.amd={jQuery:!0}}(),c("almond",function(){}),c("utils",["require","exports","module"],function(a,b,c){var d={};return d.epoch=function(){return Math.round((new Date).getTime()/1e3)},d.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},d.parseQueryString=function(a){for(var b,c=/\+/g,d=/([^&;=]+)=?([^&;]*)/g,e=function(a){return decodeURIComponent(a.replace(c," "))},f=a,g={};b=d.exec(f);)g[e(b[1])]=e(b[2]);return g},d.scopeList=function(a){return d.uniqueList(a).join(" ")},d.uniqueList=function(a){for(var b={},c=[],d=0;d<a.length;d++)b[a[d]]=1;for(var e in b)b.hasOwnProperty(e)&&c.push(e);return c},d.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},d.log=function(a){console&&console.log&&(arguments.length>1?console.log(arguments):console.log(a))},d.encodeURL=function(a,b){var c,d=a,e=0,f=a.indexOf("?")===-1?"?":"&";for(c in b)d+=(0===e++?f:"&")+encodeURIComponent(c)+"="+encodeURIComponent(b[c]);return d},d.epoch=function(){return Math.round((new Date).getTime()/1e3)},d}),c("store",["require","exports","module","./utils"],function(a,b,c){var d=a("./utils"),e={};e.saveState=function(a,b){localStorage.setItem("state-"+a,JSON.stringify(b))},e.getState=function(a){var b=JSON.parse(localStorage.getItem("state-"+a));return localStorage.removeItem("state-"+a),b};var f=function(a){console&&console.log&&(arguments.length>1?console.log(arguments):console.log(a))};return e.hasScope=function(a,b){var c;if(!a.scopes)return!1;for(c=0;c<a.scopes.length;c++)if(a.scopes[c]===b)return!0;return!1},e.filterTokens=function(a,b){var c,f,g,h=[],i=d.epoch();for(b||(b=[]),c=0;c<a.length;c++){for(g=!0,a[c].expires&&a[c].expires<i+1&&(g=!1),f=0;f<b.length;f++)e.hasScope(a[c],b[f])||(g=!1);g&&h.push(a[c])}return h},e.saveTokens=function(a,b){localStorage.setItem("tokens-"+a,JSON.stringify(b))},e.getTokens=function(a){var b=JSON.parse(localStorage.getItem("tokens-"+a));return b||(b=[]),f("Token received",b),b},e.wipeTokens=function(a){localStorage.removeItem("tokens-"+a)},e.saveToken=function(a,b){var c=this.getTokens(a);c=e.filterTokens(c),c.push(b),this.saveTokens(a,c)},e.getToken=function(a,b){var c=this.getTokens(a);return c=e.filterTokens(c,b),c.length<1?null:c[0]},e}),c("Config",[],function(){var a=function(a){for(var b=1;b<a.length;b++)for(var c in a[b])a[b].hasOwnProperty(c)&&(a[0][c]=a[b][c]);return a[0]},b=function(){for(var b=[{}],c=0;c<arguments.length;c++)b.push(arguments[c]);this.config=a(b)};return b.prototype.has=function(a){var b=this.config,c=a.split("."),d=0;for(d=0;d<c.length;d++){if(!b.hasOwnProperty(c[d]))return!1;b=b[c[d]]}return!0},b.prototype.get=function(a,b,c){c=c||!1;var d=this.config,e=a.split("."),f=0;for(f=0;f<e.length;f++){if(!d.hasOwnProperty(e[f])){d=void 0;break}d=d[e[f]]}if("undefined"==typeof d){if(c)throw new Error("Configuration option ["+e[f]+"] required but not provided.");return b}return d},b}),c("jso",["require","exports","module","./store","./utils","./Config"],function(a,b,c){var d={lifetime:3600,debug:!0,foo:{bar:"lsdkjf"}},e=a("./store"),f=a("./utils"),g=a("./Config"),i=function(a){this.config=new g(d,a),this.providerID=this.getProviderID(),i.instances[this.providerID]=this,this.callbacks={},this.callbacks.redirect=i.redirect};return i.internalStates=[],i.instances={},i.store=e,i.utils=f,console.log("RESET internalStates array"),i.enablejQuery=function(a){i.$=a},i.redirect=function(a,b){window.location=a},i.prototype.inappbrowser=function(a){var b=this;return function(c,d){var e=function(a){return function(c){var e=c.url;f.log("loadstop event triggered, and the url is now "+e),b.URLcontainsToken(e)&&(setTimeout(function(){a.close()},500),b.callback(e,function(){f.log("Closing window ",a),"function"==typeof d&&d()}))}},g="_blank";a.hasOwnProperty("target")&&(g=a.target);var h={};f.log("About to open url "+c);var i=window.open(c,g,h);f.log("URL Loaded... "),i.addEventListener("loadstart",e(i)),f.log("Event listeren ardded... ",i)}},i.prototype.on=function(a,b){if("string"!=typeof a)throw new Error("Registering triggers on JSO must be identified with an event id");if("function"!=typeof b)throw new Error("Registering a callback on JSO must be a function.");this.callbacks[a]=b},i.prototype.getProviderID=function(){var a=this.config.get("providerID",null);if(null!==a)return a;var b=this.config.get("client_id",null,!0),c=this.config.get("authorization",null,!0);return c+"|"+b},i.prototype.URLcontainsToken=function(a){if(a){if(a.indexOf("#")===-1)return!1;h=a.substring(a.indexOf("#"))}return!(h.length<2)&&h.indexOf("access_token")!==-1},i.prototype.callback=function(a,b,c){var d,g,h,j=window.location.hash,k=f.epoch();if(f.log("JSO.prototype.callback() "+a+" callback="+typeof b),a){if(a.indexOf("#")===-1)return;j=a.substring(a.indexOf("#"))}if(!(j.length<2)&&j.indexOf("access_token")!==-1){if(j=j.substring(1),d=f.parseQueryString(j),d.state)g=e.getState(d.state);else{if(!c)throw"Could not get [state] and no default providerid is provided.";g={providerID:c}}if(!g)throw"Could not retrieve state";if(!g.providerID)throw"Could not get providerid from state";if(!i.instances[g.providerID])throw"Could not retrieve JSO.instances for this provider.";h=i.instances[g.providerID],!d.state&&co.scope&&(g.scopes=h._getRequestScopes(),f.log("Setting state: ",g)),f.log("Checking atoken ",d," and instance ",h),d.expires_in?d.expires=k+parseInt(d.expires_in,10):h.config.get("default_lifetime",null)===!1||(h.config.has("permanent_scope")?e.hasScope(d,h.config.get("permanent_scope"))||(d.expires=k+15768e4):h.config.has("default_lifetime")?d.expires=k+h.config.get("default_lifetime"):d.expires=k+3600),d.scope?d.scopes=d.scope.split(" "):g.scopes&&(d.scopes=g.scopes),e.saveToken(g.providerID,d),g.restoreHash?window.location.hash=g.restoreHash:window.location.hash="",f.log(d),f.log("Looking up internalStates storage for a stored callback... ","state="+d.state,i.internalStates),i.internalStates[d.state]&&"function"==typeof i.internalStates[d.state]&&(f.log("InternalState is set, calling it now!"),i.internalStates[d.state](d),delete i.internalStates[d.state]),f.log("Successfully obtain a token, now call the callback, and may be the window closes",b),"function"==typeof b&&b(d)}},i.prototype.dump=function(){var a="",b=e.getTokens(this.providerID);return a+="Tokens: \n"+JSON.stringify(b,void 0,4)+"\n\n",a+="Config: \n"+JSON.stringify(this.config,void 0,4)+"\n\n"},i.prototype._getRequestScopes=function(a){var b,c=[];if(this.config.get("scopes")&&this.config.get("scopes").request)for(b=0;b<this.config.get("scopes").request.length;b++)c.push(this.config.get("scopes").request[b]);if(a&&a.scopes&&a.scopes.request)for(b=0;b<a.scopes.request.length;b++)c.push(a.scopes.request[b]);return f.uniqueList(c)},i.prototype._getRequiredScopes=function(a){var b,c=[];if(this.config.get("scopes")&&this.config.get("scopes").require)for(b=0;b<this.config.get("scopes").require.length;b++)c.push(this.config.get("scopes").require[b]);if(a&&a.scopes&&a.scopes.require)for(b=0;b<a.scopes.require.length;b++)c.push(a.scopes.require[b]);return f.uniqueList(c)},i.prototype.getToken=function(a,b){var c=this._getRequiredScopes(b),d=e.getToken(this.providerID,c);return d?a(d):void this._authorize(a,b)},i.prototype.checkToken=function(a){var b=this._getRequiredScopes(a);return e.getToken(this.providerID,b)},i.prototype._authorize=function(a,b){var c,d,g,h=this.config.get("authorization",null,!0),j=this.config.get("client_id",null,!0);f.log("About to send an authorization request to this entry:",h),f.log("Options",b,"callback",a),c={response_type:"token",state:f.uuid()},a&&"function"==typeof a&&(f.log("About to store a callback for later with state="+c.state,a),i.internalStates[c.state]=a),this.config.has("redirect_uri")&&(c.redirect_uri=this.config.get("redirect_uri","")),c.client_id=j,g=this._getRequestScopes(b),g.length>0&&(c.scope=f.scopeList(g)),f.log("DEBUG REQUEST"),f.log(c),d=f.encodeURL(h,c),window.location.hash&&(c.restoreHash=window.location.hash),c.providerID=this.providerID,g&&(c.scopes=g),f.log("Saving state ["+c.state+"]"),f.log(JSON.parse(JSON.stringify(c))),e.saveState(c.state,c),this.gotoAuthorizeURL(d,a)},i.prototype.gotoAuthorizeURL=function(a,b){if(!this.callbacks.redirect||"function"!=typeof this.callbacks.redirect)throw new Error("Cannot redirect to authorization endpoint because of missing redirect handler");this.callbacks.redirect(a,b)},i.prototype.wipeTokens=function(){e.wipeTokens(this.providerID)},i.prototype.ajax=function(a){var b,c=this;if(!i.hasOwnProperty("$"))throw new Error("JQuery support not enabled.");oauthOptions=a.oauth||{};var d=a.error||null;return a.error=function(a,e,g){f.log("error(jqXHR, textStatus, errorThrown)"),f.log(a),f.log(e),f.log(g),401===a.status&&(f.log("Token expired. About to delete this token"),f.log(b),c.wipeTokens()),d&&"function"==typeof d&&d(a,e,g)},this.getToken(function(b){return f.log("Ready. Got an token, and ready to perform an AJAX call",b),console.log(a.url),a.url+=(a.url.indexOf("?")===-1?"?":"&")+"access_token="+encodeURIComponent(b.access_token),console.log(a.url),"qs"===c.config.get("presenttoken",null)?(a.data||(a.data={}),a.data.access_token=b.access_token):(a.headers||(a.headers={}),a.headers.Authorization="Bearer "+b.access_token),f.log("$.ajax settings",a),i.$.ajax(a)},oauthOptions)},i}),b("jso")});